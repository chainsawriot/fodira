#!/usr/bin/env Rscript

## `links` should be a list of rds files with the standard format.

args <- commandArgs(trailingOnly = TRUE)
if ("debug" %in% args) {
    debug <- TRUE
    args <- setdiff(args, "debug")
} else {
    debug <- FALSE
}

if (length(args) == 0) {
    link_files <- readLines(file("stdin"))
} else {
    link_files <- args
}

.insert <- function(link_file, debug, newlinks_fname = "newlinks.RDS") {
    links <- readRDS(link_file)
    newlinks <- fodira::insert_doc_link(links, debug = debug, db = "main", collection = "articles")
    if (!is.null(newlinks_fname)) {
        saveRDS(newlinks, newlinks_fname)
    }
    return(invisible(link_file))
}

purrr::walk(link_files, .insert, debug = debug)
