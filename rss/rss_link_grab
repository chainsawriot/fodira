#!/usr/bin/env Rscript

## install.packages(c("tidyRSS", "purrr", "dplyr"))

args <- commandArgs(trailingOnly=TRUE)
csv <- args[1]
output_filename <- args[2]
## for debug
##csv <- "rss_list.csv"

library(magrittr)
input <- rio::import(csv)

.silent_parse <- function(url, id) {
    suppressMessages(res <- tidyRSS::tidyfeed(url))
    res$id <- id
    return(res)
}

res <- purrr::map2(input$url, input$page, purrr::safely(.silent_parse))

res %>% purrr::discard(~!is.null(.$error)) %>% purrr::map("result") %>% purrr::map(~dplyr::select(., "id", "item_link", "item_title", "item_pub_date", "item_description")) %>% dplyr::bind_rows() -> valid_links

valid_links %>% dplyr::rename(pub = `id`, link = `item_link`, pubdate = `item_pub_date`, title = `item_title`, description = `item_description`) -> output

if (!is.na(output_filename)) {
    saveRDS(output, output_filename)
} else {
    output
}
